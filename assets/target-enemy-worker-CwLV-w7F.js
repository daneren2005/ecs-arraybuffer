(function(){"use strict";function I(n){let t,s=e=>{console.warn("Updating system before sent")};self.onmessage=function(e){e.data.world?(t=e.data.world,s=n(t)):e.data.updateWorld?Object.keys(e.data.updateWorld).forEach(i=>{t[i]=e.data.updateWorld[i]}):e.data.delta&&(s(e.data.delta),self.postMessage({done:!0}))}}class b{constructor(t,s=0){this.bounds={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.maxObjects=typeof t.maxObjects=="number"?t.maxObjects:10,this.maxLevels=typeof t.maxLevels=="number"?t.maxLevels:4,this.level=s,this.objects=[],this.nodes=[]}getIndex(t){return t.qtIndex(this.bounds)}split(){const t=this.level+1,s=this.bounds.width/2,e=this.bounds.height/2,i=this.bounds.x,h=this.bounds.y,l=[{x:i+s,y:h},{x:i,y:h},{x:i,y:h+e},{x:i+s,y:h+e}];for(let o=0;o<4;o++)this.nodes[o]=new b({x:l[o].x,y:l[o].y,width:s,height:e,maxObjects:this.maxObjects,maxLevels:this.maxLevels},t)}insert(t){if(this.nodes.length){const s=this.getIndex(t);for(let e=0;e<s.length;e++)this.nodes[s[e]].insert(t);return}if(this.objects.push(t),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let s=0;s<this.objects.length;s++){const e=this.getIndex(this.objects[s]);for(let i=0;i<e.length;i++)this.nodes[e[i]].insert(this.objects[s])}this.objects=[]}}retrieve(t){const s=this.getIndex(t);let e=this.objects;if(this.nodes.length)for(let i=0;i<s.length;i++)e=e.concat(this.nodes[s[i]].retrieve(t));return this.level===0?Array.from(new Set(e)):e}remove(t,s=!1){const e=this.objects.indexOf(t);e>-1&&this.objects.splice(e,1);for(let i=0;i<this.nodes.length;i++)this.nodes[i].remove(t);return this.level===0&&!s&&this.join(),e!==-1}update(t,s=!1){this.remove(t,s),this.insert(t)}join(){let t=Array.from(this.objects);for(let e=0;e<this.nodes.length;e++){const i=this.nodes[e].join();t=t.concat(i)}const s=Array.from(new Set(t));if(s.length<=this.maxObjects){this.objects=s;for(let e=0;e<this.nodes.length;e++)this.nodes[e].objects=[];this.nodes=[]}return t}clear(){this.objects=[];for(let t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]}}class v{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.data=t.data}qtIndex(t){const s=[],e=t.x+t.width/2,i=t.y+t.height/2,h=this.y<i,l=this.x<e,o=this.x+this.width>e,c=this.y+this.height>i;return h&&o&&s.push(0),l&&h&&s.push(1),l&&c&&s.push(2),o&&c&&s.push(3),s}}function p(n){switch(n){case"entity":return 1;case"position":return 2**1;case"velocity":return 2**2;case"health":return 2**3;case"controller":return 2**4;case"controlled":return 2**5;case"attack":return 2**6;default:return 0}}function E(n){let t=0;return n.forEach(s=>{t|=p(s)}),t}function A(n,t){let s=E(t),e=[],i=Atomics.load(n.idCounter,0);for(let h=0;h<=i;h++)(Atomics.load(n.components.entity.components,h)&s)===s&&Atomics.load(n.components.entity.dead,h)===0&&e.push(h);return e}function x(n,t,s,e){return(n-s)**2+(t-e)**2}function w(n,t,s){return(Atomics.load(n.entity.components,t)&p(s))>0}function k(n){const t=n.components.position,s=n.components.controlled,e=n.components.controller,i=n.components.attack;return()=>{let l=new b({width:n.bounds.width*1e3,height:n.bounds.height*1e3});A(n,["position","health"]).forEach(o=>{let c={x:Atomics.load(t.x,o),y:Atomics.load(t.y,o),width:Atomics.load(t.width,o),height:Atomics.load(t.height,o)};l.insert(new v({...c,data:{eid:o,...c}}))}),A(n,["velocity","attack"]).forEach(o=>{let c=Atomics.load(e.color,Atomics.load(s.owner,o)),d=Atomics.load(t.x,o),a=Atomics.load(t.y,o),r=Atomics.load(t.width,o),j=Atomics.load(t.height,o),m={x:d-50*1e3,y:a-50*1e3,width:r+100*1e3,height:j+100*1e3},g=h(l,m,o,c);g.length===0&&(m.x-=100*1e3,m.y-=100*1e3,m.width+=200*1e3,m.height+=200*1e3,g=h(l,m,o,c)),g.sort((f,u)=>x(f.x,f.y,d,a)-x(u.x,u.y,d,a));let y=g[0]??null;if(!y){let f=A(n,["controller"]).filter(u=>Atomics.load(e.color,u)!==c&&!n.components.entity.dead[u]);f.sort((u,O)=>x(Atomics.load(t.x,u),Atomics.load(t.y,u),d,a)-x(Atomics.load(t.x,O),Atomics.load(t.y,O),d,a)),f.length&&(y={eid:f[0],x:0,y:0,width:0,height:0})}y?Atomics.store(i.target,o,y.eid):Atomics.store(i.target,o,0)})};function h(l,o,c,d){let a=l.retrieve(new v(o)).map(r=>r.data);return a=a.filter(r=>r.eid!==c),a.filter(r=>{if(w(n.components,r.eid,"controlled")){let j=Atomics.load(s.owner,r.eid);return Atomics.load(e.color,j)!==d}else return w(n.components,r.eid,"controller")?Atomics.load(e.color,r.eid)!==d:!1})}}I(k)})();
