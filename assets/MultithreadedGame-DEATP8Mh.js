var q=Object.defineProperty;var J=(t,s,e)=>s in t?q(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var h=(t,s,e)=>(J(t,typeof s!="symbol"?s+"":s,e),e);import{P as L,g as Q}from"./generate-scene-oCWeBa7x.js";import{E as G}from"./index-CbRDAtpo.js";import{d as K,r as S,o as X,a as Z,c as k,b as A,t as p,F as P,e as O,f as x,n as ee,p as te,g as se,_ as re}from"./index-BLx1M3Ps.js";const m=1e3;function ne(t){let s=$(t);for(;s===!1;)s=$(t);return s}function $(t){let s=Atomics.load(t.recycledIndexes,0);if(s>0){let e=Atomics.load(t.recycledIds,s);return e===0||Atomics.compareExchange(t.recycledIndexes,0,s,s-1)!==s?!1:(Atomics.compareExchange(t.recycledIds,s,e,0),Atomics.store(t.components.entity.init,e,0),Atomics.store(t.components.entity.components,e,0),Atomics.store(t.components.entity.dead,e,0),e)}else return Atomics.add(t.idCounter,0,1)+1}class V extends G{constructor(e){super();h(this,"world");h(this,"eid");h(this,"type","entity");h(this,"key","boid");this.eid=ne(e),this.world=e,this.shields=1,this.maxShields=1,this.timeToRegenerateShields=1,this.timeSinceShieldRegeneration=0,this.timeSinceTakenDamage=0,this.dead=0}get x(){return this.world.components.position.x[this.eid]}set x(e){this.world.components.position.x[this.eid]=e}get y(){return this.world.components.position.y[this.eid]}set y(e){this.world.components.position.y[this.eid]=e}get width(){return this.world.components.position.width[this.eid]}set width(e){this.world.components.position.width[this.eid]=e}get height(){return this.world.components.position.height[this.eid]}set height(e){this.world.components.position.height[this.eid]=e}get shields(){return this.world.components.health.shields[this.eid]}set shields(e){this.world.components.health.shields[this.eid]=e}get maxShields(){return this.world.components.health.maxShields[this.eid]}set maxShields(e){this.world.components.health.maxShields[this.eid]=e}get timeToRegenerateShields(){return this.world.components.health.timeToRegenerateShields[this.eid]}set timeToRegenerateShields(e){this.world.components.health.timeToRegenerateShields[this.eid]=e}get timeSinceShieldRegeneration(){return this.world.components.health.timeSinceShieldRegeneration[this.eid]}set timeSinceShieldRegeneration(e){this.world.components.health.timeSinceShieldRegeneration[this.eid]=e}get timeSinceTakenDamage(){return this.world.components.health.timeSinceTakenDamage[this.eid]}set timeSinceTakenDamage(e){this.world.components.health.timeSinceTakenDamage[this.eid]=e}get dead(){return this.world.components.health.shields[this.eid]}set dead(e){this.world.components.health.shields[this.eid]=e}load(e){Object.keys(e).forEach(r=>{r==="x"||r==="y"?this[r]=e[r]*m:this[r]=e[r]})}}function N(t){switch(t){case"entity":return 1;case"position":return 2**1;case"velocity":return 2**2;case"health":return 2**3;case"controller":return 2**4;case"controlled":return 2**5;case"attack":return 2**6;default:return 0}}function j(t){let s=0;return t.forEach(e=>{s|=N(e)}),s}function ie(t,s,e){Atomics.or(t.entity.components,s,j(e))}class oe extends V{get color(){return this.world.components.controller.color[this.eid]}set color(s){this.world.components.controller.color[this.eid]=s}get money(){return this.world.components.controller.money[this.eid]}set money(s){this.world.components.controller.money[this.eid]=s}constructor(s){super(s),ie(this.world.components,this.eid,["entity","position","health","controller"]),this.key="station",this.width=20*m,this.height=20*m,this.shields=2,this.maxShields=2,this.timeToRegenerateShields=5e3*m,Atomics.store(s.components.entity.init,this.eid,1)}}function ae(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/spawn-ship-worker-BPGl28Q1.js",{name:t==null?void 0:t.name})}function de(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/velocity-worker-DMYzNVu5.js",{name:t==null?void 0:t.name})}function he(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/collision-worker-BPpfoJFA.js",{name:t==null?void 0:t.name})}function ce(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/update-health-timers-worker-VN8WNnNM.js",{name:t==null?void 0:t.name})}function le(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/target-enemy-worker-CwLV-w7F.js",{name:t==null?void 0:t.name})}function me(t){return new Worker("/ecs-sharedarraybuffer-playground/assets/move-to-target-worker-BmpxBq_I.js",{name:t==null?void 0:t.name})}class ue extends G{constructor(){super();h(this,"bounds",{width:0,height:0});h(this,"idCounter");h(this,"recycledIds");h(this,"recycledIndexes");h(this,"components");h(this,"systems",[]);h(this,"systemUpdates",{});h(this,"workers",[]);this.idCounter=new Uint32Array(this.createBuffer(Uint32Array.BYTES_PER_ELEMENT,4)),this.recycledIds=new Uint32Array(this.createBuffer()),this.recycledIndexes=new Uint32Array(this.createBuffer(4,1)),this.components={entity:{components:new Uint32Array(this.createBuffer()),init:new Uint8Array(this.createBuffer(1)),dead:new Uint8Array(this.createBuffer(1))},position:{x:new Int32Array(this.createBuffer()),y:new Int32Array(this.createBuffer()),width:new Int32Array(this.createBuffer()),height:new Int32Array(this.createBuffer()),angle:new Int32Array(this.createBuffer())},velocity:{x:new Int32Array(this.createBuffer()),y:new Int32Array(this.createBuffer()),speed:new Int32Array(this.createBuffer())},health:{shields:new Int32Array(this.createBuffer()),maxShields:new Int32Array(this.createBuffer()),timeToRegenerateShields:new Int32Array(this.createBuffer()),timeSinceShieldRegeneration:new Int32Array(this.createBuffer()),timeSinceTakenDamage:new Int32Array(this.createBuffer())},controller:{color:new Int32Array(this.createBuffer()),money:new Int32Array(this.createBuffer())},controlled:{owner:new Int32Array(this.createBuffer())},attack:{target:new Int32Array(this.createBuffer())}},this.addSystemWorker("spawnShipSystem",new ae),this.addSystemWorker("velocitySystem",new de),this.addSystemWorker("collisionSystem",new he),this.addSystemWorker("updateHealthTimersSystem",new ce),this.addSystemWorker("targetEnemySystem",new le),this.addSystemWorker("moveToTargetSystem",new me)}createBuffer(e=4,r=1e4){return new SharedArrayBuffer(r*e)}load(e){e.entities.forEach(r=>{let a;switch(r.type){case"station":a=new oe(this);break;default:a=new V(this);break}a.load(r)}),e.bounds&&(this.bounds=e.bounds),this.workers.forEach(r=>{r.postMessage({updateWorld:{bounds:this.bounds}})})}update(e){this.systems.forEach(r=>{r(e)})}addSystem(e,r){this.systems.push(a=>{let o=performance.now();r(a),this.systemUpdates[e].push(performance.now()-o)}),this.systemUpdates[e]=[]}addSystemWorker(e,r){let a=0,o=0;this.systems.push(y=>{if(a){o+=y;return}a=performance.now(),r.postMessage({delta:y+o}),o=0}),this.systemUpdates[e]=[];let v={idCounter:this.idCounter,recycledIds:this.recycledIds,recycledIndexes:this.recycledIndexes,bounds:this.bounds,components:this.components};r.postMessage({functionName:e,world:v}),r.onmessage=y=>{y.data.done&&(this.systemUpdates[e].push(performance.now()-a),a=0)},this.workers.push(r)}destroy(){this.workers.forEach(e=>{e.terminate()}),this.workers=[]}}function _(t,s){let e=j(s),r=[],a=Atomics.load(t.idCounter,0);for(let o=0;o<=a;o++)(Atomics.load(t.components.entity.components,o)&e)===e&&Atomics.load(t.components.entity.dead,o)===0&&r.push(o);return r}function pe(t,s){let e=j(s),r=[],a=Atomics.load(t.idCounter,0);for(let o=0;o<=a;o++)(Atomics.load(t.components.entity.components,o)&e)===e&&r.push(o);return r}function M(t,s,e){return(Atomics.load(t.entity.components,s)&N(e))>0}const z=t=>(te("data-v-cd415b18"),t=t(),se(),t),fe={key:0,class:"home"},ye={class:"list"},ge={style:{color:"red"}},we=z(()=>A("p",null,null,-1)),Se=z(()=>A("div",{id:"phaser-container-multithreaded"},null,-1)),Ae={key:1},Ie=K({__name:"MultithreadedGame",setup(t){const s=!!window.SharedArrayBuffer;let e;const r=S(0),a=S(0),o=S(0),v=S(0),y=S(0),b=S([]),E=S([]);let T;X(()=>{e=new ue;let I=0,g=[];const c=window.innerWidth/3*2,D=window.innerHeight/3*2;let U=!1;const C=new Map;let R;T=new L.Game({type:L.AUTO,width:c,height:D,parent:"phaser-container-multithreaded",scene:{preload(){this.load.image("boid","boid.png"),this.load.image("station","station.png"),this.load.image("shield","shield3.png")},create(){R=this.add,e.load(Q({stations:10,shipsPerStation:100,width:c,height:D}));let F=_(e,["controller"]);b.value=F.map(w=>{let W=e.components.controller.color[w],f="#"+W.toString(16);return f==="#ffffff"&&(f="#00000"),{eid:w,color:W,displayColor:f,ships:0}}),this.input.keyboard.on("keydown-SPACE",()=>{U=!U}),Object.keys(e.systemUpdates).forEach(w=>{E.value.push({name:w,min:0,avg:0,max:0})})},update(F,w){if(U)return;let W=performance.now();e.update(w);let f=e.components.position;pe(e,["position","health"]).forEach(i=>{let n=C.get(i);if(e.components.entity.dead[i])n&&(n.destroy(),n.shieldImage.destroy(),C.delete(i));else{if(!n){if(Atomics.load(e.components.entity.init,i)===0)return;n=R.image(0,0,M(e.components,i,"controller")?"station":"boid"),n.setScale(f.width[i]/n.width/m,f.height[i]/n.height/m),n.shieldImage=R.image(0,0,"shield"),n.shieldImage.setScale(f.width[i]/n.shieldImage.width/m*2,f.height[i]/n.shieldImage.height/m*2),C.set(i,n)}if(n.x=n.shieldImage.x=e.components.position.x[i]/m,n.y=n.shieldImage.y=e.components.position.y[i]/m,n.angle=n.shieldImage.angle=e.components.position.angle[i],n.shieldImage.visible=e.components.health.shields[i]>0,M(e.components,i,"controller"))n.setTint(Atomics.load(e.components.controller.color,i));else if(M(e.components,i,"controlled")){let d=Atomics.load(e.components.controlled.owner,i);n.setTint(Atomics.load(e.components.controller.color,d))}}});let Y=performance.now();if(g.push(Y-W),I+=w,I>m){r.value=g.reduce((d,l)=>Math.min(d,l),1e6),a.value=g.reduce((d,l)=>Math.max(d,l),0),o.value=g.reduce((d,l)=>d+l,0)/g.length,g=[],I=0;let i=_(e,["controller"]),n=_(e,["controlled"]);v.value=i.length,y.value=n.length,b.value.forEach(d=>{i.find(u=>e.components.controller.color[u]===d.color)!==void 0?d.ships=n.filter(u=>e.components.controlled.owner[u]===d.eid).length:d.ships>0&&(d.ships=0)}),E.value=[],Object.keys(e.systemUpdates).forEach(d=>{let l=e.systemUpdates[d];E.value.push({name:d,min:l.reduce((u,B)=>Math.min(u,B),1e6),avg:l.reduce((u,B)=>u+B,0)/l.length,max:l.reduce((u,B)=>Math.max(u,B),0)}),e.systemUpdates[d]=[]})}}}})}),Z(()=>{T&&(T.destroy(),T=null),e&&e.destroy()});function H(){_(e,["controller"]).forEach(I=>{e.components.controller.money[I]+=10})}return(I,g)=>s?(x(),k("div",fe,[A("div",ye,[A("div",ge,"mainThread: "+p(a.value.toFixed(2))+" ("+p(o.value.toFixed(2))+" avg) ms",1),(x(!0),k(P,null,O(E.value,c=>(x(),k("div",{key:c.name},p(c.name)+": "+p(c.max.toFixed(2))+" ("+p(c.avg.toFixed(2))+" avg) ms",1))),128)),we,A("div",null,"Entities: "+p(v.value)+" stations and "+p(y.value)+" ships",1),(x(!0),k(P,null,O(b.value,c=>(x(),k("span",{class:"station-list",key:c.color,style:ee({color:c.displayColor})},p("#"+c.color.toString(16))+": "+p(c.ships),5))),128)),A("div",null,[A("button",{onClick:H},"Add Ships")])]),Se])):(x(),k("div",Ae," Browser does not suport SharedArrayBuffer "))}}),Ee=re(Ie,[["__scopeId","data-v-cd415b18"]]);export{Ee as default};
