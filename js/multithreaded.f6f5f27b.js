(self["webpackChunkecs_sharedarraybuffer_playground"]=self["webpackChunkecs_sharedarraybuffer_playground"]||[]).push([[110],{4019:function(e){e.exports="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView},260:function(e,t,r){"use strict";var o,n,i,s=r(4019),a=r(9781),d=r(7854),h=r(614),c=r(111),l=r(2597),p=r(648),u=r(6330),m=r(8880),y=r(8052),f=r(3070).f,w=r(7976),g=r(9518),A=r(7674),S=r(5112),v=r(9711),I=d.Int8Array,x=I&&I.prototype,T=d.Uint8ClampedArray,k=T&&T.prototype,R=I&&g(I),b=x&&g(x),E=Object.prototype,U=d.TypeError,B=S("toStringTag"),_=v("TYPED_ARRAY_TAG"),C=v("TYPED_ARRAY_CONSTRUCTOR"),D=s&&!!A&&"Opera"!==p(d.opera),W=!1,O={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Z={BigInt64Array:8,BigUint64Array:8},Y=function(e){if(!c(e))return!1;var t=p(e);return"DataView"===t||l(O,t)||l(Z,t)},H=function(e){if(!c(e))return!1;var t=p(e);return l(O,t)||l(Z,t)},M=function(e){if(H(e))return e;throw U("Target is not a typed array")},P=function(e){if(h(e)&&(!A||w(R,e)))return e;throw U(u(e)+" is not a typed array constructor")},z=function(e,t,r,o){if(a){if(r)for(var n in O){var i=d[n];if(i&&l(i.prototype,e))try{delete i.prototype[e]}catch(s){try{i.prototype[e]=t}catch(h){}}}b[e]&&!r||y(b,e,r?t:D&&x[e]||t,o)}},F=function(e,t,r){var o,n;if(a){if(A){if(r)for(o in O)if(n=d[o],n&&l(n,e))try{delete n[e]}catch(i){}if(R[e]&&!r)return;try{return y(R,e,r?t:D&&R[e]||t)}catch(i){}}for(o in O)n=d[o],!n||n[e]&&!r||y(n,e,t)}};for(o in O)n=d[o],i=n&&n.prototype,i?m(i,C,n):D=!1;for(o in Z)n=d[o],i=n&&n.prototype,i&&m(i,C,n);if((!D||!h(R)||R===Function.prototype)&&(R=function(){throw U("Incorrect invocation")},D))for(o in O)d[o]&&A(d[o],R);if((!D||!b||b===E)&&(b=R.prototype,D))for(o in O)d[o]&&A(d[o].prototype,b);if(D&&g(k)!==b&&A(k,b),a&&!l(b,B))for(o in W=!0,f(b,B,{get:function(){return c(this)?this[_]:void 0}}),O)d[o]&&m(d[o],_,o);e.exports={NATIVE_ARRAY_BUFFER_VIEWS:D,TYPED_ARRAY_CONSTRUCTOR:C,TYPED_ARRAY_TAG:W&&_,aTypedArray:M,aTypedArrayConstructor:P,exportTypedArrayMethod:z,exportTypedArrayStaticMethod:F,isView:Y,isTypedArray:H,TypedArray:R,TypedArrayPrototype:b}},8544:function(e,t,r){var o=r(7293);e.exports=!o((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))},9518:function(e,t,r){var o=r(7854),n=r(2597),i=r(614),s=r(7908),a=r(6200),d=r(8544),h=a("IE_PROTO"),c=o.Object,l=c.prototype;e.exports=d?c.getPrototypeOf:function(e){var t=s(e);if(n(t,h))return t[h];var r=t.constructor;return i(r)&&t instanceof r?r.prototype:t instanceof c?l:null}},4590:function(e,t,r){var o=r(7854),n=r(3002),i=o.RangeError;e.exports=function(e,t){var r=n(e);if(r%t)throw i("Wrong offset");return r}},3002:function(e,t,r){var o=r(7854),n=r(9303),i=o.RangeError;e.exports=function(e){var t=n(e);if(t<0)throw i("The argument can't be less than 0");return t}},3004:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return D}});var o=r(3396),n=r(7139),i=r(4870),s=r(3836),a=r.n(s),d=r(238),h=r(2482),c=(r(8675),r(3462),r(6856));const l=1e3;function p(e){let t=u(e);while(!1===t)t=u(e);return t}function u(e){let t=Atomics.load(e.recycledIndexes,0);if(t>0){let r=Atomics.load(e.recycledIds,t);if(0===r)return!1;let o=Atomics.compareExchange(e.recycledIndexes,0,t,t-1);return o===t&&(Atomics.compareExchange(e.recycledIds,t,r,0),Atomics.store(e.components.entity.init,r,0),Atomics.store(e.components.entity.components,r,0),Atomics.store(e.components.entity.dead,r,0),r)}return Atomics.add(e.idCounter,0,1)+1}class m extends c.EventEmitter{get x(){return this.world.components.position.x[this.eid]}set x(e){this.world.components.position.x[this.eid]=e}get y(){return this.world.components.position.y[this.eid]}set y(e){this.world.components.position.y[this.eid]=e}get width(){return this.world.components.position.width[this.eid]}set width(e){this.world.components.position.width[this.eid]=e}get height(){return this.world.components.position.height[this.eid]}set height(e){this.world.components.position.height[this.eid]=e}get shields(){return this.world.components.health.shields[this.eid]}set shields(e){this.world.components.health.shields[this.eid]=e}get maxShields(){return this.world.components.health.maxShields[this.eid]}set maxShields(e){this.world.components.health.maxShields[this.eid]=e}get timeToRegenerateShields(){return this.world.components.health.timeToRegenerateShields[this.eid]}set timeToRegenerateShields(e){this.world.components.health.timeToRegenerateShields[this.eid]=e}get timeSinceShieldRegeneration(){return this.world.components.health.timeSinceShieldRegeneration[this.eid]}set timeSinceShieldRegeneration(e){this.world.components.health.timeSinceShieldRegeneration[this.eid]=e}get timeSinceTakenDamage(){return this.world.components.health.timeSinceTakenDamage[this.eid]}set timeSinceTakenDamage(e){this.world.components.health.timeSinceTakenDamage[this.eid]=e}get dead(){return this.world.components.health.shields[this.eid]}set dead(e){this.world.components.health.shields[this.eid]=e}constructor(e){super(),(0,h.Z)(this,"world",void 0),(0,h.Z)(this,"eid",void 0),(0,h.Z)(this,"type","entity"),(0,h.Z)(this,"key","boid"),this.eid=p(e),this.world=e,this.shields=1,this.maxShields=1,this.timeToRegenerateShields=1,this.timeSinceShieldRegeneration=0,this.timeSinceTakenDamage=0,this.dead=0}load(e){Object.keys(e).forEach((t=>{this[t]="x"===t||"y"===t?e[t]*l:e[t]}))}}function y(e){switch(e){case"entity":return 1;case"position":return 2;case"velocity":return 4;case"health":return 8;case"controller":return 16;case"controlled":return 32;case"attack":return 64;default:return 0}}function f(e){let t=0;return e.forEach((e=>{t|=y(e)})),t}function w(e,t,r){Atomics.or(e.entity.components,t,f(r))}class g extends m{get color(){return this.world.components.controller.color[this.eid]}set color(e){this.world.components.controller.color[this.eid]=e}get money(){return this.world.components.controller.money[this.eid]}set money(e){this.world.components.controller.money[this.eid]=e}constructor(e){super(e),w(this.world.components,this.eid,["entity","position","health","controller"]),this.key="station",this.width=20*l,this.height=20*l,this.shields=2,this.maxShields=2,this.timeToRegenerateShields=5e3*l,Atomics.store(e.components.entity.init,this.eid,1)}}class A extends c.EventEmitter{constructor(){super(),(0,h.Z)(this,"bounds",{width:0,height:0}),(0,h.Z)(this,"idCounter",void 0),(0,h.Z)(this,"recycledIds",void 0),(0,h.Z)(this,"recycledIndexes",void 0),(0,h.Z)(this,"components",void 0),(0,h.Z)(this,"systems",[]),(0,h.Z)(this,"systemUpdates",{}),(0,h.Z)(this,"workers",[]),this.idCounter=new Uint32Array(this.createBuffer(Uint32Array.BYTES_PER_ELEMENT,4)),this.recycledIds=new Uint32Array(this.createBuffer()),this.recycledIndexes=new Uint32Array(this.createBuffer(4,1)),this.components={entity:{components:new Uint32Array(this.createBuffer()),init:new Uint8Array(this.createBuffer(1)),dead:new Uint8Array(this.createBuffer(1))},position:{x:new Int32Array(this.createBuffer()),y:new Int32Array(this.createBuffer()),width:new Int32Array(this.createBuffer()),height:new Int32Array(this.createBuffer()),angle:new Int32Array(this.createBuffer())},velocity:{x:new Int32Array(this.createBuffer()),y:new Int32Array(this.createBuffer()),speed:new Int32Array(this.createBuffer())},health:{shields:new Int32Array(this.createBuffer()),maxShields:new Int32Array(this.createBuffer()),timeToRegenerateShields:new Int32Array(this.createBuffer()),timeSinceShieldRegeneration:new Int32Array(this.createBuffer()),timeSinceTakenDamage:new Int32Array(this.createBuffer())},controller:{color:new Int32Array(this.createBuffer()),money:new Int32Array(this.createBuffer())},controlled:{owner:new Int32Array(this.createBuffer())},attack:{target:new Int32Array(this.createBuffer())}},this.addSystemWorker("spawnShipSystem",new Worker(new URL(r.p+r.u(462),r.b))),this.addSystemWorker("velocitySystem",new Worker(new URL(r.p+r.u(626),r.b))),this.addSystemWorker("collisionSystem",new Worker(new URL(r.p+r.u(47),r.b))),this.addSystemWorker("updateHealthTimersSystem",new Worker(new URL(r.p+r.u(870),r.b))),this.addSystemWorker("targetEnemySystem",new Worker(new URL(r.p+r.u(550),r.b))),this.addSystemWorker("moveToTargetSystem",new Worker(new URL(r.p+r.u(561),r.b)))}createBuffer(e=4,t=1e4){return new SharedArrayBuffer(t*e)}load(e){e.entities.forEach((e=>{let t;switch(e.type){case"station":t=new g(this);break;default:t=new m(this);break}t.load(e)})),e.bounds&&(this.bounds=e.bounds),this.workers.forEach((e=>{e.postMessage({updateWorld:{bounds:this.bounds}})}))}update(e){this.systems.forEach((t=>{t(e)}))}addSystem(e,t){this.systems.push((r=>{let o=performance.now();t(r),this.systemUpdates[e].push(performance.now()-o)})),this.systemUpdates[e]=[]}addSystemWorker(e,t){let r=0,o=0;this.systems.push((e=>{r?o+=e:(r=performance.now(),t.postMessage({delta:e+o}),o=0)})),this.systemUpdates[e]=[];let n={idCounter:this.idCounter,recycledIds:this.recycledIds,recycledIndexes:this.recycledIndexes,bounds:this.bounds,components:this.components};t.postMessage({functionName:e,world:n}),t.onmessage=t=>{t.data.done&&(this.systemUpdates[e].push(performance.now()-r),r=0)},this.workers.push(t)}destroy(){this.workers.forEach((e=>{e.terminate()})),this.workers=[]}}function S(e,t){let r=f(t),o=[],n=Atomics.load(e.idCounter,0);for(let i=0;i<=n;i++)(Atomics.load(e.components.entity.components,i)&r)===r&&0===Atomics.load(e.components.entity.dead,i)&&o.push(i);return o}function v(e,t){let r=f(t),o=[],n=Atomics.load(e.idCounter,0);for(let i=0;i<=n;i++)(Atomics.load(e.components.entity.components,i)&r)===r&&o.push(i);return o}function I(e,t,r){return(Atomics.load(e.entity.components,t)&y(r))>0}const x=e=>((0,o.dD)("data-v-06cb6eda"),e=e(),(0,o.Cn)(),e),T={key:0,class:"home"},k={class:"list"},R={style:{color:"red"}},b=x((()=>(0,o._)("p",null,null,-1))),E=x((()=>(0,o._)("div",{id:"phaser-container-multithreaded"},null,-1))),U={key:1};var B=(0,o.aZ)({setup(e){const t=!!window.SharedArrayBuffer;let r;const s=(0,i.iH)(0),h=(0,i.iH)(0),c=(0,i.iH)(0),p=(0,i.iH)(0),u=(0,i.iH)(0),m=(0,i.iH)([]),y=(0,i.iH)([]);let f;function w(){S(r,["controller"]).forEach((e=>{r.components.controller.money[e]+=10}))}return(0,o.bv)((()=>{r=new A;let e=0,t=[];const o=window.innerWidth/3*2,n=window.innerHeight/3*2;let i=!1;const w=new Map;let g;f=new(a().Game)({type:a().AUTO,width:o,height:n,parent:"phaser-container-multithreaded",scene:{preload(){this.load.image("boid","boid.png"),this.load.image("station","station.png"),this.load.image("shield","shield3.png")},create(){g=this.add,r.load((0,d.Z)({stations:10,shipsPerStation:100,width:o,height:n}));let e=S(r,["controller"]);m.value=e.map((e=>{let t=r.components.controller.color[e],o="#"+t.toString(16);return"#ffffff"===o&&(o="#00000"),{eid:e,color:t,displayColor:o,ships:0}})),this.input.keyboard.on("keydown-SPACE",(()=>{i=!i})),Object.keys(r.systemUpdates).forEach((e=>{y.value.push({name:e,min:0,avg:0,max:0})}))},update(o,n){if(i)return;let a=performance.now();r.update(n);let d=r.components.position;v(r,["position","health"]).forEach((e=>{let t=w.get(e);if(r.components.entity.dead[e])t&&(t.destroy(),t.shieldImage.destroy(),w.delete(e));else{if(!t){if(0===Atomics.load(r.components.entity.init,e))return;t=g.image(0,0,I(r.components,e,"controller")?"station":"boid"),t.setScale(d.width[e]/t.width/l,d.height[e]/t.height/l),t.shieldImage=g.image(0,0,"shield"),t.shieldImage.setScale(d.width[e]/t.shieldImage.width/l*2,d.height[e]/t.shieldImage.height/l*2),w.set(e,t)}if(t.x=t.shieldImage.x=r.components.position.x[e]/l,t.y=t.shieldImage.y=r.components.position.y[e]/l,t.angle=t.shieldImage.angle=r.components.position.angle[e],t.shieldImage.visible=r.components.health.shields[e]>0,I(r.components,e,"controller"))t.setTint(Atomics.load(r.components.controller.color,e));else if(I(r.components,e,"controlled")){let o=Atomics.load(r.components.controlled.owner,e);t.setTint(Atomics.load(r.components.controller.color,o))}}}));let f=performance.now();if(t.push(f-a),e+=n,e>l){s.value=t.reduce(((e,t)=>Math.min(e,t)),1e6),h.value=t.reduce(((e,t)=>Math.max(e,t)),0),c.value=t.reduce(((e,t)=>e+t),0)/t.length,t=[],e=0;let o=S(r,["controller"]),n=S(r,["controlled"]);p.value=o.length,u.value=n.length,m.value.forEach((e=>{let t=o.find((t=>r.components.controller.color[t]===e.color));void 0!==t?e.ships=n.filter((t=>r.components.controlled.owner[t]===e.eid)).length:e.ships>0&&(e.ships=0)})),y.value=[],Object.keys(r.systemUpdates).forEach((e=>{let t=r.systemUpdates[e];y.value.push({name:e,min:t.reduce(((e,t)=>Math.min(e,t)),1e6),avg:t.reduce(((e,t)=>e+t),0)/t.length,max:t.reduce(((e,t)=>Math.max(e,t)),0)}),r.systemUpdates[e]=[]}))}}}})})),(0,o.Jd)((()=>{f&&(f.destroy(),f=null),r&&r.destroy()})),(e,r)=>t?((0,o.wg)(),(0,o.iD)("div",T,[(0,o._)("div",k,[(0,o._)("div",R,"mainThread: "+(0,n.zw)(h.value.toFixed(2))+" ("+(0,n.zw)(c.value.toFixed(2))+" avg) ms",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,i.SU)(y),(e=>((0,o.wg)(),(0,o.iD)("div",{key:e.name},(0,n.zw)(e.name)+": "+(0,n.zw)(e.max.toFixed(2))+" ("+(0,n.zw)(e.avg.toFixed(2))+" avg) ms",1)))),128)),b,(0,o._)("div",null,"Entities: "+(0,n.zw)(p.value)+" stations and "+(0,n.zw)(u.value)+" ships",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,i.SU)(m),(e=>((0,o.wg)(),(0,o.iD)("span",{class:"station-list",key:e.color,style:(0,n.j5)({color:e.displayColor})},(0,n.zw)("#"+e.color.toString(16))+": "+(0,n.zw)(e.ships),5)))),128)),(0,o._)("div",null,[(0,o._)("button",{onClick:w},"Add Ships")])]),E])):((0,o.wg)(),(0,o.iD)("div",U," Browser does not suport SharedArrayBuffer "))}}),_=r(89);const C=(0,_.Z)(B,[["__scopeId","data-v-06cb6eda"]]);var D=C}}]);
//# sourceMappingURL=multithreaded.f6f5f27b.js.map