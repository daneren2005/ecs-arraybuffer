"use strict";(self["webpackChunkecs_sharedarraybuffer_playground"]=self["webpackChunkecs_sharedarraybuffer_playground"]||[]).push([[816],{7309:function(e,t,n){n.d(t,{l:function(){return i}});var o=n(2482);class i{constructor(e,t=0){(0,o.Z)(this,"bounds",void 0),(0,o.Z)(this,"maxObjects",void 0),(0,o.Z)(this,"maxLevels",void 0),(0,o.Z)(this,"level",void 0),(0,o.Z)(this,"objects",void 0),(0,o.Z)(this,"nodes",void 0),this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects="number"===typeof e.maxObjects?e.maxObjects:10,this.maxLevels="number"===typeof e.maxLevels?e.maxLevels:4,this.level=t,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,t=this.bounds.width/2,n=this.bounds.height/2,o=this.bounds.x,s=this.bounds.y,r=[{x:o+t,y:s},{x:o,y:s},{x:o,y:s+n},{x:o+t,y:s+n}];for(let h=0;h<4;h++)this.nodes[h]=new i({x:r[h].x,y:r[h].y,width:t,height:n,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const t=this.getIndex(e);for(let n=0;n<t.length;n++)this.nodes[t[n]].insert(e)}else if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let e=0;e<this.objects.length;e++){const t=this.getIndex(this.objects[e]);for(let n=0;n<t.length;n++)this.nodes[t[n]].insert(this.objects[e])}this.objects=[]}}retrieve(e){const t=this.getIndex(e);let n=this.objects;if(this.nodes.length)for(let o=0;o<t.length;o++)n=n.concat(this.nodes[t[o]].retrieve(e));return n=n.filter((function(e,t){return n.indexOf(e)>=t})),n}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}},8973:function(e,t,n){n.d(t,{A:function(){return i}});var o=n(2482);class i{constructor(e){(0,o.Z)(this,"x",void 0),(0,o.Z)(this,"y",void 0),(0,o.Z)(this,"width",void 0),(0,o.Z)(this,"height",void 0),(0,o.Z)(this,"data",void 0),this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const t=[],n=e.x+e.width/2,o=e.y+e.height/2,i=this.y<o,s=this.x<n,r=this.x+this.width>n,h=this.y+this.height>o;return i&&r&&t.push(0),s&&i&&t.push(1),s&&h&&t.push(2),r&&h&&t.push(3),t}}},6065:function(e,t,n){function o(e,t,n,o){return Math.sqrt((e-n)**2+(t-o)**2)}n.d(t,{Z:function(){return o}})},1396:function(e,t,n){function o(e,t,n,o){return(e-n)**2+(t-o)**2}n.d(t,{Z:function(){return o}})},1432:function(e,t,n){n.r(t),n.d(t,{default:function(){return zt}});var o=n(3396),i=n(7139),s=n(4870),r=n(3836),h=n.n(r),l=n(238),a=n(2482),d=(n(8675),n(3462),n(1703),n(6699),{i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"}),c={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},m={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},u={uint8:256,uint16:65536,uint32:2**32},y=e=>t=>Math.ceil(t/e)*e,p=y(4),f=Symbol("storeRef"),g=Symbol("storeSize"),w=Symbol("storeMaps"),S=Symbol("storeFlattened"),b=Symbol("storeBase"),v=Symbol("storeType"),x=Symbol("storeArrayElementCounts"),E=Symbol("storeSubarrays"),k=Symbol("subarrayCursors"),T=Symbol("subarray"),M=(Symbol("subarrayFrom"),Symbol("subarrayTo"),Symbol("parentArray")),j=Symbol("tagStore"),A=(Symbol("queryShadow"),Symbol("serializeShadow"),Symbol("indexType")),Z=Symbol("indexBytes"),R=Symbol("isEidType"),C={},I=(e,t)=>{const n=new ArrayBuffer(t*e.BYTES_PER_ELEMENT),o=new e.constructor(n);return o.set(e,0),o},O=(e,t)=>{if(ArrayBuffer.isView(e))e[t]=e.slice(0);else{const n=e[M].slice(0);e[t]=e.map(((t,o)=>{const{length:i}=e[o],s=i*o,r=s+i;return n.subarray(s,r)}))}},_=(e,t,n)=>{const o=e[k];let i=t[v];const s=t[0].length,r=s<=u.uint8?d.ui8:s<=u.uint16?d.ui16:d.ui32;if(0===o[i]){const t=e[x][i],o=new m[i](p(t*n));o.set(e[E][i]),e[E][i]=o,o[A]=c[r],o[Z]=m[r].BYTES_PER_ELEMENT}const h=o[i],l=h+n*s;o[i]=l,t[M]=e[E][i].subarray(h,l);for(let a=0;a<n;a++){const e=s*a,n=e+s;t[a]=t[M].subarray(e,n),t[a][A]=c[r],t[a][Z]=m[r].BYTES_PER_ELEMENT,t[a][T]=!0}},U=(e,t,n)=>{Object.keys(t).forEach((o=>{const i=t[o];Array.isArray(i)?(_(e,i,n),t[S].push(i)):ArrayBuffer.isView(i)?(t[o]=I(i,n),t[S].push(t[o])):"object"===typeof i&&U(e,t[o],n)}))},q=(e,t)=>{e[j]||(e[g]=t,e[S].length=0,Object.keys(e[k]).forEach((t=>{e[k][t]=0})),U(e,e,t))},z=(e,t)=>{e[S]&&e[S].forEach((e=>{ArrayBuffer.isView(e)?e[t]=0:e[t].fill(0)}))},D=(e,t)=>{const n=t*m[e].BYTES_PER_ELEMENT,o=new ArrayBuffer(n),i=new m[e](o);return i[R]=e===d.eid,i},B=(e,t,n)=>{const o=e[g],i=Array(o).fill(0);i[v]=t,i[R]=t===d.eid;const s=e[k],r=n<=u.uint8?d.ui8:n<=u.uint16?d.ui16:d.ui32;if(!n)throw new Error("bitECS - Must define component array length");if(!m[t])throw new Error(`bitECS - Invalid component array property type ${t}`);if(!e[E][t]){const n=e[x][t],i=new m[t](p(n*o));i[A]=c[r],i[Z]=m[r].BYTES_PER_ELEMENT,e[E][t]=i}const h=s[t],l=h+o*n;s[t]=l,i[M]=e[E][t].subarray(h,l);for(let a=0;a<o;a++){const e=n*a,t=e+n;i[a]=i[M].subarray(e,t),i[a][A]=c[r],i[a][Z]=m[r].BYTES_PER_ELEMENT,i[a][T]=!0}return i},L=e=>Array.isArray(e)&&"string"===typeof e[0]&&"number"===typeof e[1],P=(e,t)=>{const n=Symbol("store");if(!e||!Object.keys(e).length)return C[n]={[g]:t,[j]:!0,[b]:()=>C[n]},C[n];e=JSON.parse(JSON.stringify(e));const o={},i=e=>{const t=Object.keys(e);for(const n of t)L(e[n])?(o[e[n][0]]||(o[e[n][0]]=0),o[e[n][0]]+=e[n][1]):e[n]instanceof Object&&i(e[n])};i(e);const s={[g]:t,[w]:{},[E]:{},[f]:n,[k]:Object.keys(m).reduce(((e,t)=>({...e,[t]:0})),{}),[S]:[],[x]:o};if(e instanceof Object&&Object.keys(e).length){const o=(e,i)=>{if("string"===typeof e[i])e[i]=D(e[i],t),e[i][b]=()=>C[n],s[S].push(e[i]);else if(L(e[i])){const[t,o]=e[i];e[i]=B(s,t,o),e[i][b]=()=>C[n],s[S].push(e[i])}else e[i]instanceof Object&&(e[i]=Object.keys(e[i]).reduce(o,e[i]));return e};return C[n]=Object.assign(Object.keys(e).reduce(o,e),s),C[n][b]=()=>C[n],C[n]}},Y=()=>{const e=[],t=[];e.sort=function(n){const o=Array.prototype.sort.call(this,n);for(let i=0;i<e.length;i++)t[e[i]]=i;return o};const n=n=>e[t[n]]===n,o=o=>{n(o)||(t[o]=e.push(o)-1)},i=o=>{if(!n(o))return;const i=t[o],s=e.pop();s!==o&&(e[i]=s,t[s]=i)};return{add:o,remove:i,has:n,sparse:t,dense:e}},H=e=>{e},F=e=>t=>!e(t),N=e=>e[S],Q=N,V=(F(Q),e=>"function"===typeof e),X=(F(V),Symbol("entityMasks")),$=Symbol("entityComponents"),J=Symbol("entitySparseSet"),K=Symbol("entityArray"),G=(Symbol("entityIndices"),Symbol("removedEntities"),1e5),W=0,ee=G,te=()=>ee-ee/5,ne=()=>ee,oe=[],ie=()=>{ee=G,W=0,oe.length=0},se=e=>{const t=ee;G=e,ie(),ee=e,Xe(e),Ue(e),H(!0),console.info(`ðŸ‘¾ bitECS - resizing all data stores from ${t} to ${e}`)},re=()=>W,he=new Map,le=e=>{if(W>=te()){const e=ee,t=4*Math.ceil(e/2/4);se(e+t)}const t=oe.length>Math.round(.01*G)?oe.shift():W++;return e[J].add(t),he.set(t,e),e[pe].forEach((n=>{const o=Ae(e,n,t);o&&Ze(n,t)})),e[$].set(t,new Set),t},ae=(e,t)=>{if(e[J].has(t)){e[ye].forEach((n=>{Ie(e,n,t)})),oe.push(t),e[J].remove(t),e[$].delete(t),e[Ne].delete(e[Qe].get(t)),e[Qe].delete(t);for(let n=0;n<e[X].length;n++)e[X][n][t]=0}};function de(e){return()=>[e,"changed"]}function ce(...e){return function(){return e}}function me(...e){return function(){return e}}function ue(...e){return function(){return e}}var ye=Symbol("queries"),pe=Symbol("notQueries"),fe=Symbol("queryAny"),ge=Symbol("queryAll"),we=Symbol("queryNone"),Se=Symbol("queryMap"),be=Symbol("$dirtyQueries"),ve=Symbol("queryComponents"),xe=(Symbol("enterQuery"),Symbol("exitQuery"),(e,t)=>{const n=[],o=[],i=[];t[ve].forEach((t=>{if("function"===typeof t){const[s,r]=t();e[Oe].has(s)||De(e,s),"not"===r&&o.push(s),"changed"===r&&(i.push(s),n.push(s))}else e[Oe].has(t)||De(e,t),n.push(t)}));const s=t=>e[Oe].get(t),r=n.concat(o).map(s),h=Y(),l=[],a=[],d=Y(),c=Y(),m=Y(),u=r.map((e=>e.generationId)).reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[]),y=(e,t)=>(e[t.generationId]||(e[t.generationId]=0),e[t.generationId]|=t.bitflag,e),p=n.map(s).reduce(y,{}),f=o.map(s).reduce(y,{}),g=r.reduce(y,{}),w=n.filter((e=>!e[j])).map((e=>Object.getOwnPropertySymbols(e).includes(S)?e[S]:[e])).reduce(((e,t)=>e.concat(t)),[]),b=[],v=Object.assign(h,{archetypes:l,changed:a,components:n,notComponents:o,changedComponents:i,allComponents:r,masks:p,notMasks:f,hasMasks:g,generations:u,flatProps:w,toRemove:d,entered:c,exited:m,shadows:b});e[Se].set(t,v),e[ye].add(v),r.forEach((e=>{e.queries.add(v)})),o.length&&e[pe].add(v);for(let S=0;S<re();S++){if(!e[J].has(S))continue;const t=Ae(e,v,S);t&&Ze(v,S)}}),Ee=(e,t)=>{const n=Symbol(),o=e.flatProps[t];return O(o,n),e.shadows[t]=o[n],o[n]},ke=(e,t)=>{t&&(e.changed=[]);const{flatProps:n,shadows:o}=e;for(let i=0;i<e.dense.length;i++){const t=e.dense[i];let s=!1;for(let i=0;i<n.length;i++){const r=n[i],h=o[i]||Ee(e,i);if(ArrayBuffer.isView(r[t])){for(let e=0;e<r[t].length;e++)if(r[t][e]!==h[t][e]){s=!0;break}h[t].set(r[t])}else r[t]!==h[t]&&(s=!0,h[t]=r[t])}s&&e.changed.push(t)}return e.changed},Te=(e,t)=>e.concat(t),Me=e=>t=>t.filter((t=>t.name===e().constructor.name)).reduce(Te),je=(Me(ce),Me(me),Me(ue),(...e)=>{let t,n,o,i;if(Array.isArray(e[0])&&(t=e[0]),void 0===t||void 0!==t[Oe])return e=>e?e[K]:t[K];const s=function(e,t=!0){e[Se].has(s)||xe(e,s);const n=e[Se].get(s);return Ce(e),n.changedComponents.length?ke(n,t):n.dense};return s[ve]=t,s[fe]=n,s[ge]=o,s[we]=i,s}),Ae=(e,t,n)=>{const{masks:o,notMasks:i,generations:s}=t;for(let r=0;r<s.length;r++){const t=s[r],h=o[t],l=i[t],a=e[X][t][n];if(l&&0!==(a&l))return!1;if(h&&(a&h)!==h)return!1}return!0},Ze=(e,t)=>{e.toRemove.remove(t),e.entered.add(t),e.add(t)},Re=e=>{for(let t=e.toRemove.dense.length-1;t>=0;t--){const n=e.toRemove.dense[t];e.toRemove.remove(n),e.remove(n)}},Ce=e=>{e[be].size&&(e[be].forEach(Re),e[be].clear())},Ie=(e,t,n)=>{t.has(n)&&!t.toRemove.has(n)&&(t.toRemove.add(n),e[be].add(t),t.exited.add(n))},Oe=Symbol("componentMap"),_e=[],Ue=e=>{_e.forEach((t=>q(t,e)))},qe=(e,t)=>{const n=P(e,t||ne());return e&&Object.keys(e).length&&_e.push(n),n},ze=e=>{e[He]*=2,e[He]>=2**31&&(e[He]=1,e[X].push(new Uint32Array(e[Pe])))},De=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");const n=new Set,o=new Set,i=new Set;e[ye].forEach((e=>{e.allComponents.includes(t)&&n.add(e)})),e[Oe].set(t,{generationId:e[X].length-1,bitflag:e[He],store:t,queries:n,notQueries:o,changedQueries:i}),t[g]<ne()&&q(t,ne()),ze(e)},Be=(e,t,n)=>{const o=e[Oe].get(t);if(!o)return!1;const{generationId:i,bitflag:s}=o,r=e[X][i][n];return(r&s)===s},Le=(e,t,n,o=!1)=>{if(void 0===n)throw new Error("bitECS - entity is undefined.");if(!e[J].has(n))throw new Error("bitECS - entity does not exist in the world.");if(e[Oe].has(t)||De(e,t),Be(e,t,n))return;const i=e[Oe].get(t),{generationId:s,bitflag:r,queries:h,notQueries:l}=i;e[X][s][n]|=r,h.forEach((t=>{t.toRemove.has(n)&&t.toRemove.remove(n);const o=Ae(e,t,n);o&&Ze(t,n),o||Ie(e,t,n)})),e[$].get(n).add(t),o&&z(t,n)},Pe=Symbol("size"),Ye=Symbol("resizeThreshold"),He=Symbol("bitflag"),Fe=Symbol("archetypes"),Ne=Symbol("localEntities"),Qe=Symbol("localEntityLookp"),Ve=[],Xe=e=>{Ve.forEach((t=>{t[Pe]=e;for(let n=0;n<t[X].length;n++){const o=t[X][n];t[X][n]=I(o,e)}t[Ye]=t[Pe]-t[Pe]/5}))},$e=(...e)=>{const t="object"===typeof e[0]?e[0]:{},n="number"===typeof e[0]?e[0]:"number"===typeof e[1]?e[1]:ne();return Je(t,n),Ve.push(t),t},Je=(e,t=ne())=>(e[Pe]=t,e[K]&&e[K].forEach((t=>ae(e,t))),e[X]=[new Uint32Array(t)],e[$]=new Map,e[Fe]=[],e[J]=Y(),e[K]=e[J].dense,e[He]=1,e[Oe]=new Map,e[Se]=new Map,e[ye]=new Set,e[pe]=new Set,e[be]=new Set,e[Ne]=new Map,e[Qe]=new Map,e),Ke=d,Ge=n(6856);class We extends Ge.EventEmitter{get x(){return this.world.components.position.x[this.eid]}set x(e){this.world.components.position.x[this.eid]=e}get y(){return this.world.components.position.y[this.eid]}set y(e){this.world.components.position.y[this.eid]=e}get width(){return this.world.components.position.width[this.eid]}set width(e){this.world.components.position.width[this.eid]=e}get height(){return this.world.components.position.height[this.eid]}set height(e){this.world.components.position.height[this.eid]=e}get shields(){return this.world.components.health.shields[this.eid]}set shields(e){this.world.components.health.shields[this.eid]=e}get maxShields(){return this.world.components.health.maxShields[this.eid]}set maxShields(e){this.world.components.health.maxShields[this.eid]=e}get timeToRegenerateShields(){return this.world.components.health.timeToRegenerateShields[this.eid]}set timeToRegenerateShields(e){this.world.components.health.timeToRegenerateShields[this.eid]=e}get timeSinceShieldRegeneration(){return this.world.components.health.timeSinceShieldRegeneration[this.eid]}set timeSinceShieldRegeneration(e){this.world.components.health.timeSinceShieldRegeneration[this.eid]=e}get timeSinceTakenDamage(){return this.world.components.health.timeSinceTakenDamage[this.eid]}set timeSinceTakenDamage(e){this.world.components.health.timeSinceTakenDamage[this.eid]=e}get dead(){return this.world.components.health.shields[this.eid]}set dead(e){this.world.components.health.shields[this.eid]=e}constructor(e){super(),(0,a.Z)(this,"world",void 0),(0,a.Z)(this,"eid",void 0),(0,a.Z)(this,"type","entity"),(0,a.Z)(this,"key","boid"),this.eid=le(e.ecs),this.world=e,this.addComponent(e.components.position),this.addComponent(e.components.health),this.shields=1,this.maxShields=1,this.timeToRegenerateShields=1,this.timeSinceShieldRegeneration=0,this.timeSinceTakenDamage=0,this.dead=0}load(e){Object.keys(e).forEach((t=>{this[t]=e[t]}))}set(e,t,n){this.world.components[e][t][this.eid]=n}addComponent(e){Le(this.world.ecs,e,this.eid)}}class et extends We{get color(){return this.world.components.controller.color[this.eid]}set color(e){this.world.components.controller.color[this.eid]=e}get money(){return this.world.components.controller.money[this.eid]}set money(e){this.world.components.controller.money[this.eid]=e}constructor(e){super(e),this.addComponent(e.components.controller),this.key="station",this.width=20,this.height=20,this.shields=2,this.maxShields=2,this.timeToRegenerateShields=5}}var tt=n(2254);class nt extends We{get color(){return this.world.components.controller.color[this.world.components.controlled.owner[this.eid]]}get velocityX(){return this.world.components.velocity.x[this.eid]}set velocityX(e){this.world.components.velocity.x[this.eid]=e}get velocityY(){return this.world.components.velocity.y[this.eid]}set velocityY(e){this.world.components.velocity.y[this.eid]=e}get station(){return this.world.getEntity(this.eid)}constructor(e){super(e.world);let t=e.world;this.addComponent(t.components.velocity),this.addComponent(t.components.controlled),this.addComponent(t.components.attack),this.width=10,this.height=5,this.shields=1,this.maxShields=1,this.timeToRegenerateShields=1,this.world.components.velocity.speed[this.eid]=100,t.components.controlled.owner[this.eid]=e.eid}}function ot(e){const t=e.components.controller,n=e.components.health;let o=je([t]);return i=>{let s=o(i).filter((e=>!n.dead[e]));return s.forEach((n=>{let o=e.getEntity(n);if(t.money[n]>0){let i=new nt(o);i.x=o.x,i.y=o.y,i.velocityX=(Math.random()>.5?-1:1)*Math.random()*e.components.velocity.speed[i.eid],i.velocityY=(Math.random()>.5?-1:1)*Math.random()*e.components.velocity.speed[i.eid],e.components.position.angle[i.eid]=(0,tt.Z)(i.velocityX,i.velocityY),e.addEntity(i),t.money[n]--}})),i}}var it={x:Ke.f32,y:Ke.f32,width:Ke.f32,height:Ke.f32,angle:Ke.f32},st={color:Ke.f32,money:Ke.i32},rt={x:Ke.f32,y:Ke.f32,speed:Ke.f32},ht={shields:Ke.i32,maxShields:Ke.i32,timeToRegenerateShields:Ke.f32,timeSinceShieldRegeneration:Ke.f32,timeSinceTakenDamage:Ke.f32,dead:Ke.ui8},lt={owner:Ke.eid},at={target:Ke.eid},dt={position:qe(it),controller:qe(st),velocity:qe(rt),health:qe(ht),controlled:qe(lt),attack:qe(at)};function ct(e){const t=e.components.position,n=e.components.velocity;let o=je([t,n]);return(i,s)=>{let r=o(i);return r.forEach((o=>{t.x[o]+=n.x[o]*s,t.y[o]+=n.y[o]*s,(t.x[o]<0||t.x[o]>e.bounds.width)&&(n.x[o]=-n.x[o],t.angle[o]=(0,tt.Z)(n.x[o],n.y[o])),(t.y[o]<0||t.y[o]>e.bounds.height)&&(n.y[o]=-n.y[o],t.angle[o]=(0,tt.Z)(n.x[o],n.y[o]))})),i}}var mt=n(8973),ut=n(6065);function yt(e){const t=e.components.position,n=e.components.velocity,o=e.components.controlled,i=e.components.controller,s=e.components.health;let r=je([n]);const h=.03;let l=h+1,a=[],d=0;return(c,m)=>{l+=m,l>h&&0===a.length&&(a=r(c).filter((e=>!s.dead[e])),d=a.length/2,l=0);let u=c.quadtree,y=performance.now();for(let s=0;s<a.length;s++){let r=a[s],h=u.retrieve(new mt.A({x:t.x[r],y:t.y[r],width:t.width[r],height:t.height[r]})).map((e=>e.data.eid)).filter((e=>e!==r)),l=i.color[o.owner[r]],p=h.filter((e=>{if(Be(c,o,e)){let t=o.owner[e];return i.color[t]!==l}return!!Be(c,i,e)&&i.color[e]!==l})),f=p.filter((e=>(0,ut.Z)(t.x[e],t.y[e],t.x[r],t.y[r])<Math.max(t.width[r],t.width[e])));if(f.length&&(pt(e,a,r,f[0]),n.x[r]=-n.x[r],n.y[r]=-n.y[r],t.angle[r]=(0,tt.Z)(n.x[r],n.y[r])),s%10===0&&s>d&&performance.now()-y>1e3*m/2)return a=a.slice(s),c}return a=[],c}}function pt(e,t,n,o){if(!gt(e,n)||!gt(e,o))return;let i=1;Be(e.ecs,e.components.controller,o)&&(i=t.filter((t=>e.components.controlled.owner[t]===o)).length),ft(e,t,n,1),ft(e,t,o,1);const s=e.components.controlled;if(e.components.health.dead[o]){let t=s.owner[n];e.components.controller.money[t]+=i}if(e.components.health.dead[n])if(Be(e.ecs,s,o)){let t=s.owner[o];e.components.controller.money[t]+=1}else Be(e.ecs,e.components.controller,o)&&(e.components.controller.money[o]+=1)}function ft(e,t,n,o){const i=e.components.health;if(i.shields[n]-=o,i.timeSinceTakenDamage[n]=0,i.shields[n]<0&&(i.dead[n]=1,Be(e.ecs,e.components.controller,n))){let o=t.filter((t=>e.components.controlled.owner[t]===n));o.forEach((e=>{i.dead[e]=1}))}}function gt(e,t){return e.components.health.timeSinceTakenDamage[t]>=.2}var wt=n(1396);function St(e){const t=e.components.position,n=e.components.velocity,o=e.components.controlled,i=e.components.controller,s=e.components.health,r=e.components.attack;let h=je([n,r]),l=je([i]);const a=.2;let d=a+1,c=[],m=0;return(n,u)=>{d+=u,d>a&&0===c.length&&(c=h(n).filter((e=>!s.dead[e])),m=c.length/(a/u),d=0);let y=n.quadtree,p=performance.now();for(let h=0;h<c.length;h++){let a=c[h],d=i.color[o.owner[a]],f={x:t.x[a]-50,y:t.y[a]-50,width:t.width[a]+100,height:t.height[a]+100},g=bt(y,n,f,a,d,e);0===g.length&&(f.x-=100,f.y-=100,f.width+=200,f.height+=200,g=bt(y,n,f,a,d,e)),g.sort(((e,n)=>(0,wt.Z)(t.x[e],t.y[e],t.x[a],t.y[a])-(0,wt.Z)(t.x[n],t.y[n],t.x[a],t.y[a])));let w=g[0]??0;if(!w){let e=l(n).filter((e=>i.color[e]!==d&&!s.dead[e]));e.sort(((e,n)=>(0,wt.Z)(t.x[e],t.y[e],t.x[a],t.y[a])-(0,wt.Z)(t.x[n],t.y[n],t.x[a],t.y[a]))),w=e[0]??0}if(r.target[a]=w,h%10===0&&h>m&&performance.now()-p>1e3*u/2)return c=c.slice(h),n}return c=[],n}}function bt(e,t,n,o,i,s){const r=s.components.controlled,h=s.components.controller;let l=e.retrieve(new mt.A(n)).map((e=>e.data.eid)).filter((e=>e!==o));return l.filter((e=>{if(Be(t,r,e)){let t=r.owner[e];return h.color[t]!==i}return!!Be(t,h,e)&&h.color[e]!==i}))}var vt=n(7309);function xt(e){const t=e.components.position,n=e.components.health;let o=je([t,n]);return i=>{let s=new vt.l({width:e.bounds.width,height:e.bounds.height});return o(i).forEach((e=>{n.dead[e]||s.insert(new mt.A({x:t.x[e],y:t.y[e],width:t.width[e],height:t.height[e],data:{eid:e}}))})),i.quadtree=s,i}}function Et(e){const t=e.components.health;let n=je([t]);return(e,o)=>(n(e).forEach((e=>{t.timeSinceTakenDamage[e]+=o,t.shields[e]<t.maxShields[e]&&(t.timeSinceShieldRegeneration[e]+=o,t.timeSinceShieldRegeneration[e]>t.timeToRegenerateShields[e]&&(t.shields[e]++,t.timeSinceShieldRegeneration[e]=0))})),e)}const kt=n(3129);function Tt(e){const t=e.components.position,n=e.components.velocity,o=e.components.attack,i=e.components.health;let s=je([n,o]);return e=>(s(e).forEach((e=>{let s=o.target[e];if(!s||i.dead[s])return;let r=Mt(t,e,s),h=new kt.Vector2(n.x[e]+4*r.x,n.y[e]+4*r.y);h.normalize(),n.x[e]=h.x*n.speed[e],n.y[e]=h.y*n.speed[e],t.angle[e]=(0,tt.Z)(n.x[e],n.y[e])})),e)}function Mt(e,t,n){let o=new kt.Vector2(e.x[n]-e.x[t],e.y[n]-e.y[t]);return o.normalize(),o}class jt extends Ge.EventEmitter{get entities(){return[...this.eidMap.values()]}constructor(){super(),(0,a.Z)(this,"ecs",void 0),(0,a.Z)(this,"eidMap",new Map),(0,a.Z)(this,"bounds",{width:0,height:0}),(0,a.Z)(this,"components",dt),(0,a.Z)(this,"systems",[]),(0,a.Z)(this,"systemUpdates",{}),this.ecs=$e(),this.addSystem("quadTreeSystem",xt(this)),this.addSystem("spawnShipSystem",ot(this)),this.addSystem("targetEnemySystem",St(this)),this.addSystem("moveToTargetSystem",Tt(this)),this.addSystem("velocitySystem",ct(this)),this.addSystem("collisionSystem",yt(this)),this.addSystem("updateHealthTimersSystem",Et(this))}load(e){e.entities.forEach((e=>{let t;switch(e.type){case"station":t=new et(this);break;default:t=new We(this);break}t.load(e),this.addEntity(t)})),e.bounds&&(this.bounds=e.bounds)}addEntity(e){this.emit("entity-added",e),this.eidMap.set(e.eid,e)}removeEntity(e){ae(this.ecs,e),this.eidMap.delete(e)}getEntity(e){return this.eidMap.get(e)??null}update(e){this.systems.forEach((t=>{t(this.ecs,e)}))}addSystem(e,t){this.systems.push(((n,o)=>{let i=performance.now();return t(n,o),this.systemUpdates[e].push(performance.now()-i),n})),this.systemUpdates[e]=[]}}const At=e=>((0,o.dD)("data-v-4e495fc6"),e=e(),(0,o.Cn)(),e),Zt={class:"home"},Rt={class:"list"},Ct={style:{color:"red"}},It=At((()=>(0,o._)("p",null,null,-1))),Ot=At((()=>(0,o._)("div",{id:"phaser-container-bitecs"},null,-1)));var _t=(0,o.aZ)({setup(e){let t=new jt;const n=(0,s.iH)(0),r=(0,s.iH)(0),a=(0,s.iH)(0),d=(0,s.iH)(0),c=(0,s.iH)(0),m=(0,s.iH)([]),u=je([dt.controller]),y=(0,s.iH)([]);let p;function f(){u(t.ecs).forEach((e=>{t.components.controller.money[e]+=10}))}return(0,o.bv)((()=>{let e=0,o=[];const i=window.innerWidth/3*2,s=window.innerHeight/3*2;let f=!1;const g=je([de(dt.position)]),w=je([de(dt.health)]),S=je([dt.controlled]),b=new Map;p=new(h().Game)({type:h().AUTO,width:i,height:s,parent:"phaser-container-bitecs",scene:{preload(){this.load.image("boid","boid.png"),this.load.image("station","station.png"),this.load.image("shield","shield3.png")},create(){t.on("entity-added",(e=>{let t=this.add.image(e.x,e.y,e.key);t.setScale(e.width/t.width,e.height/t.height),t.shieldImage=this.add.image(e.x,e.y,"shield"),t.shieldImage.setScale(e.width/t.shieldImage.width*2,e.height/t.shieldImage.height*2),t.shieldImage.visible=e.shields>0,(e instanceof et||e instanceof nt)&&t.setTint(e.color),b.set(e.eid,t)})),t.load((0,l.Z)({stations:6,shipsPerStation:100,width:i,height:s}));let e=t.entities.filter((e=>e instanceof et));m.value=e.map((e=>{let t="#"+e.color.toString(16);return"#ffffff"===t&&(t="#00000"),{eid:e.eid,color:e.color,displayColor:t,ships:0}})),this.input.keyboard.on("keydown-SPACE",(()=>{f=!f})),Object.keys(t.systemUpdates).forEach((e=>{y.value.push({name:e,min:0,avg:0,max:0})}))},update(i,s){if(f)return;let h=performance.now();t.update(s/1e3),g(t.ecs).forEach((e=>{let t=b.get(e);t&&(t.x=t.shieldImage.x=dt.position.x[e],t.y=t.shieldImage.y=dt.position.y[e],t.angle=t.shieldImage.angle=dt.position.angle[e])})),w(t.ecs).forEach((e=>{let t=b.get(e);t&&(t.shieldImage.visible=dt.health.shields[e]>0,dt.health.dead[e]&&(t.destroy(),t.shieldImage.destroy(),b.delete(e)))}));let l=performance.now();if(o.push(l-h),e+=s,e>1e3){n.value=o.reduce(((e,t)=>Math.min(e,t)),1e6),r.value=o.reduce(((e,t)=>Math.max(e,t)),0),a.value=o.reduce(((e,t)=>e+t),0)/o.length,o=[],e=0,d.value=t.entities.filter((e=>e instanceof et)).length;let i=u(t.ecs).filter((e=>!dt.health.dead[e])),s=S(t.ecs).filter((e=>!dt.health.dead[e]));c.value=s.length,m.value.forEach((e=>{let t=i.find((t=>dt.controller.color[t]===e.color));void 0!==t?e.ships=s.filter((t=>dt.controlled.owner[t]===e.eid)).length:e.ships>0&&(e.ships=0)})),y.value=[],Object.keys(t.systemUpdates).forEach((e=>{let n=t.systemUpdates[e];y.value.push({name:e,min:n.reduce(((e,t)=>Math.min(e,t)),1e6),avg:n.reduce(((e,t)=>e+t),0)/n.length,max:n.reduce(((e,t)=>Math.max(e,t)),0)}),t.systemUpdates[e]=[]}))}}}})})),(0,o.Jd)((()=>{p&&(p.destroy(),p=null)})),(e,t)=>((0,o.wg)(),(0,o.iD)("div",Zt,[(0,o._)("div",Rt,[(0,o._)("div",Ct,"mainThread: "+(0,i.zw)(r.value.toFixed(2))+" ("+(0,i.zw)(a.value.toFixed(2))+" avg) ms",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,s.SU)(y),(e=>((0,o.wg)(),(0,o.iD)("div",{key:e.name},(0,i.zw)(e.name)+": "+(0,i.zw)(e.max.toFixed(2))+" ("+(0,i.zw)(e.avg.toFixed(2))+" avg) ms",1)))),128)),It,(0,o._)("div",null,"Entities: "+(0,i.zw)(d.value)+" stations and "+(0,i.zw)(c.value)+" ships",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,s.SU)(m),(e=>((0,o.wg)(),(0,o.iD)("span",{class:"station-list",key:e.color,style:(0,i.j5)({color:e.displayColor})},(0,i.zw)("#"+e.color.toString(16))+": "+(0,i.zw)(e.ships),5)))),128)),(0,o._)("div",null,[(0,o._)("button",{onClick:f},"Add Ships")])]),Ot]))}}),Ut=n(89);const qt=(0,Ut.Z)(_t,[["__scopeId","data-v-4e495fc6"]]);var zt=qt}}]);
//# sourceMappingURL=bitecs.0ad5089e.js.map