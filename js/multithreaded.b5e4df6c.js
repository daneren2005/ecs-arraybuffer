(self["webpackChunkecs_arraybuffer"]=self["webpackChunkecs_arraybuffer"]||[]).push([[110],{4019:function(e){e.exports="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView},260:function(e,t,r){"use strict";var o,i,n,s=r(4019),a=r(9781),h=r(7854),d=r(614),l=r(111),c=r(2597),p=r(648),m=r(6330),u=r(8880),y=r(8052),g=r(3070).f,f=r(7976),w=r(9518),A=r(7674),S=r(5112),v=r(9711),I=h.Int8Array,T=I&&I.prototype,k=h.Uint8ClampedArray,R=k&&k.prototype,x=I&&w(I),b=T&&w(T),E=Object.prototype,U=h.TypeError,_=S("toStringTag"),C=v("TYPED_ARRAY_TAG"),D=v("TYPED_ARRAY_CONSTRUCTOR"),W=s&&!!A&&"Opera"!==p(h.opera),O=!1,Z={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Y={BigInt64Array:8,BigUint64Array:8},H=function(e){if(!l(e))return!1;var t=p(e);return"DataView"===t||c(Z,t)||c(Y,t)},M=function(e){if(!l(e))return!1;var t=p(e);return c(Z,t)||c(Y,t)},P=function(e){if(M(e))return e;throw U("Target is not a typed array")},z=function(e){if(d(e)&&(!A||f(x,e)))return e;throw U(m(e)+" is not a typed array constructor")},B=function(e,t,r,o){if(a){if(r)for(var i in Z){var n=h[i];if(n&&c(n.prototype,e))try{delete n.prototype[e]}catch(s){try{n.prototype[e]=t}catch(d){}}}b[e]&&!r||y(b,e,r?t:W&&T[e]||t,o)}},F=function(e,t,r){var o,i;if(a){if(A){if(r)for(o in Z)if(i=h[o],i&&c(i,e))try{delete i[e]}catch(n){}if(x[e]&&!r)return;try{return y(x,e,r?t:W&&x[e]||t)}catch(n){}}for(o in Z)i=h[o],!i||i[e]&&!r||y(i,e,t)}};for(o in Z)i=h[o],n=i&&i.prototype,n?u(n,D,i):W=!1;for(o in Y)i=h[o],n=i&&i.prototype,n&&u(n,D,i);if((!W||!d(x)||x===Function.prototype)&&(x=function(){throw U("Incorrect invocation")},W))for(o in Z)h[o]&&A(h[o],x);if((!W||!b||b===E)&&(b=x.prototype,W))for(o in Z)h[o]&&A(h[o].prototype,b);if(W&&w(R)!==b&&A(R,b),a&&!c(b,_))for(o in O=!0,g(b,_,{get:function(){return l(this)?this[C]:void 0}}),Z)h[o]&&u(h[o],C,o);e.exports={NATIVE_ARRAY_BUFFER_VIEWS:W,TYPED_ARRAY_CONSTRUCTOR:D,TYPED_ARRAY_TAG:O&&C,aTypedArray:P,aTypedArrayConstructor:z,exportTypedArrayMethod:B,exportTypedArrayStaticMethod:F,isView:H,isTypedArray:M,TypedArray:x,TypedArrayPrototype:b}},8544:function(e,t,r){var o=r(7293);e.exports=!o((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))},9518:function(e,t,r){var o=r(7854),i=r(2597),n=r(614),s=r(7908),a=r(6200),h=r(8544),d=a("IE_PROTO"),l=o.Object,c=l.prototype;e.exports=h?l.getPrototypeOf:function(e){var t=s(e);if(i(t,d))return t[d];var r=t.constructor;return n(r)&&t instanceof r?r.prototype:t instanceof l?c:null}},4590:function(e,t,r){var o=r(7854),i=r(3002),n=o.RangeError;e.exports=function(e,t){var r=i(e);if(r%t)throw n("Wrong offset");return r}},3002:function(e,t,r){var o=r(7854),i=r(9303),n=o.RangeError;e.exports=function(e){var t=i(e);if(t<0)throw n("The argument can't be less than 0");return t}},6871:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return C}});var o=r(3396),i=r(7139),n=r(4870),s=r(3836),a=r.n(s),h=r(238),d=r(2482),l=(r(8675),r(3462),r(6856));const c=1e3;class p extends l.EventEmitter{get x(){return this.world.components.position.x[this.eid]}set x(e){this.world.components.position.x[this.eid]=e}get y(){return this.world.components.position.y[this.eid]}set y(e){this.world.components.position.y[this.eid]=e}get width(){return this.world.components.position.width[this.eid]}set width(e){this.world.components.position.width[this.eid]=e}get height(){return this.world.components.position.height[this.eid]}set height(e){this.world.components.position.height[this.eid]=e}get shields(){return this.world.components.health.shields[this.eid]}set shields(e){this.world.components.health.shields[this.eid]=e}get maxShields(){return this.world.components.health.maxShields[this.eid]}set maxShields(e){this.world.components.health.maxShields[this.eid]=e}get timeToRegenerateShields(){return this.world.components.health.timeToRegenerateShields[this.eid]}set timeToRegenerateShields(e){this.world.components.health.timeToRegenerateShields[this.eid]=e}get timeSinceShieldRegeneration(){return this.world.components.health.timeSinceShieldRegeneration[this.eid]}set timeSinceShieldRegeneration(e){this.world.components.health.timeSinceShieldRegeneration[this.eid]=e}get timeSinceTakenDamage(){return this.world.components.health.timeSinceTakenDamage[this.eid]}set timeSinceTakenDamage(e){this.world.components.health.timeSinceTakenDamage[this.eid]=e}get dead(){return this.world.components.health.shields[this.eid]}set dead(e){this.world.components.health.shields[this.eid]=e}constructor(e){super(),(0,d.Z)(this,"world",void 0),(0,d.Z)(this,"eid",void 0),(0,d.Z)(this,"type","entity"),(0,d.Z)(this,"key","boid"),this.eid=e.getId(),this.world=e,this.shields=1,this.maxShields=1,this.timeToRegenerateShields=1,this.timeSinceShieldRegeneration=0,this.timeSinceTakenDamage=0,this.dead=0}load(e){Object.keys(e).forEach((t=>{this[t]="x"===t||"y"===t?e[t]*c:e[t]}))}}function m(e){switch(e){case"entity":return 1;case"position":return 2;case"velocity":return 4;case"health":return 8;case"controller":return 16;case"controlled":return 32;case"attack":return 64;default:return 0}}function u(e){let t=0;return e.forEach((e=>{t|=m(e)})),t}function y(e,t,r){Atomics.or(e.entity.components,t,u(r))}class g extends p{get color(){return this.world.components.controller.color[this.eid]}set color(e){this.world.components.controller.color[this.eid]=e}get money(){return this.world.components.controller.money[this.eid]}set money(e){this.world.components.controller.money[this.eid]=e}constructor(e){super(e),y(this.world.components,this.eid,["entity","position","health","controller"]),this.key="station",this.width=20*c,this.height=20*c,this.shields=2,this.maxShields=2,this.timeToRegenerateShields=5e3*c,Atomics.store(e.components.entity.init,this.eid,1)}}class f extends l.EventEmitter{constructor(){super(),(0,d.Z)(this,"bounds",{width:0,height:0}),(0,d.Z)(this,"idCounter",void 0),(0,d.Z)(this,"components",void 0),(0,d.Z)(this,"systems",[]),(0,d.Z)(this,"systemUpdates",{}),(0,d.Z)(this,"workers",[]),this.idCounter=this.createIntegerArray(4),this.components={entity:{components:this.createIntegerArray(),init:this.createIntegerArray(),dead:this.createIntegerArray()},position:{x:this.createIntegerArray(),y:this.createIntegerArray(),width:this.createIntegerArray(),height:this.createIntegerArray(),angle:this.createIntegerArray()},velocity:{x:this.createIntegerArray(),y:this.createIntegerArray(),speed:this.createIntegerArray()},health:{shields:this.createIntegerArray(),maxShields:this.createIntegerArray(),timeToRegenerateShields:this.createIntegerArray(),timeSinceShieldRegeneration:this.createIntegerArray(),timeSinceTakenDamage:this.createIntegerArray()},controller:{color:this.createIntegerArray(),money:this.createIntegerArray()},controlled:{owner:this.createIntegerArray()},attack:{target:this.createIntegerArray()}},this.addSystemWorker("spawnShipSystem",new Worker(new URL(r.p+r.u(789),r.b))),this.addSystemWorker("velocitySystem",new Worker(new URL(r.p+r.u(626),r.b))),this.addSystemWorker("collisionSystem",new Worker(new URL(r.p+r.u(809),r.b))),this.addSystemWorker("updateHealthTimersSystem",new Worker(new URL(r.p+r.u(513),r.b))),this.addSystemWorker("targetEnemySystem",new Worker(new URL(r.p+r.u(624),r.b))),this.addSystemWorker("moveToTargetSystem",new Worker(new URL(r.p+r.u(561),r.b)))}createIntegerArray(e=65536){let t=new SharedArrayBuffer(e*Int32Array.BYTES_PER_ELEMENT);return new Int32Array(t)}load(e){e.entities.forEach((e=>{let t;switch(e.type){case"station":t=new g(this);break;default:t=new p(this);break}t.load(e)})),e.bounds&&(this.bounds=e.bounds),this.workers.forEach((e=>{e.postMessage({updateWorld:{bounds:this.bounds}})}))}getId(){return Atomics.add(this.idCounter,0,1)+1}update(e){this.systems.forEach((t=>{t(e)}))}addSystem(e,t){this.systems.push((r=>{let o=performance.now();t(r),this.systemUpdates[e].push(performance.now()-o)})),this.systemUpdates[e]=[]}addSystemWorker(e,t){let r=0,o=0;this.systems.push((e=>{r?o+=e:(r=performance.now(),t.postMessage({delta:e+o}),o=0)})),this.systemUpdates[e]=[];let i={idCounter:this.idCounter,bounds:this.bounds,components:this.components};t.postMessage({functionName:e,world:i}),t.onmessage=t=>{t.data.done&&(this.systemUpdates[e].push(performance.now()-r),r=0)},this.workers.push(t)}destroy(){this.workers.forEach((e=>{e.terminate()})),this.workers=[]}}function w(e,t){let r=u(t),o=[],i=Atomics.load(e.idCounter,0);for(let n=0;n<=i;n++)(Atomics.load(e.components.entity.components,n)&r)===r&&0===Atomics.load(e.components.entity.dead,n)&&o.push(n);return o}function A(e,t){let r=u(t),o=[],i=Atomics.load(e.idCounter,0);for(let n=0;n<=i;n++)(Atomics.load(e.components.entity.components,n)&r)===r&&o.push(n);return o}function S(e,t,r){return(Atomics.load(e.entity.components,t)&m(r))>0}const v=e=>((0,o.dD)("data-v-448ca91a"),e=e(),(0,o.Cn)(),e),I={key:0,class:"home"},T={class:"list"},k={style:{color:"red"}},R=v((()=>(0,o._)("p",null,null,-1))),x=v((()=>(0,o._)("div",{id:"phaser-container-multithreaded"},null,-1))),b={key:1};var E=(0,o.aZ)({setup(e){const t=!!window.SharedArrayBuffer;let r;const s=(0,n.iH)(0),d=(0,n.iH)(0),l=(0,n.iH)(0),p=(0,n.iH)(0),m=(0,n.iH)(0),u=(0,n.iH)([]),y=(0,n.iH)([]);let g;function v(){w(r,["controller"]).forEach((e=>{r.components.controller.money[e]+=10}))}return(0,o.bv)((()=>{r=new f;let e=0,t=[];const o=window.innerWidth/3*2,i=window.innerHeight/3*2;let n=!1;const v=new Map;let I;g=new(a().Game)({type:a().AUTO,width:o,height:i,parent:"phaser-container-multithreaded",scene:{preload(){this.load.image("boid","boid.png"),this.load.image("station","station.png"),this.load.image("shield","shield3.png")},create(){I=this.add,r.load((0,h.Z)({stations:10,shipsPerStation:100,width:o,height:i}));let e=w(r,["controller"]);u.value=e.map((e=>{let t=r.components.controller.color[e],o="#"+t.toString(16);return"#ffffff"===o&&(o="#00000"),{eid:e,color:t,displayColor:o,ships:0}})),this.input.keyboard.on("keydown-SPACE",(()=>{n=!n})),Object.keys(r.systemUpdates).forEach((e=>{y.value.push({name:e,min:0,avg:0,max:0})}))},update(o,i){if(n)return;let a=performance.now();r.update(i);let h=r.components.position;A(r,["position","health"]).forEach((e=>{let t=v.get(e);if(r.components.entity.dead[e])t&&(t.destroy(),t.shieldImage.destroy(),v.delete(e));else{if(!t){if(0===Atomics.load(r.components.entity.init,e))return;if(t=I.image(0,0,S(r.components,e,"controller")?"station":"boid"),t.setScale(h.width[e]/t.width/c,h.height[e]/t.height/c),t.shieldImage=I.image(0,0,"shield"),t.shieldImage.setScale(h.width[e]/t.shieldImage.width/c*2,h.height[e]/t.shieldImage.height/c*2),S(r.components,e,"controller"))t.setTint(Atomics.load(r.components.controller.color,e));else if(S(r.components,e,"controlled")){let o=Atomics.load(r.components.controlled.owner,e);t.setTint(Atomics.load(r.components.controller.color,o))}v.set(e,t)}t.x=t.shieldImage.x=r.components.position.x[e]/c,t.y=t.shieldImage.y=r.components.position.y[e]/c,t.angle=t.shieldImage.angle=r.components.position.angle[e],t.shieldImage.visible=r.components.health.shields[e]>0}}));let g=performance.now();if(t.push(g-a),e+=i,e>c){s.value=t.reduce(((e,t)=>Math.min(e,t)),1e6),d.value=t.reduce(((e,t)=>Math.max(e,t)),0),l.value=t.reduce(((e,t)=>e+t),0)/t.length,t=[],e=0;let o=w(r,["controller"]),i=w(r,["controlled"]);p.value=o.length,m.value=i.length,u.value.forEach((e=>{let t=o.find((t=>r.components.controller.color[t]===e.color));void 0!==t?e.ships=i.filter((t=>r.components.controlled.owner[t]===e.eid)).length:e.ships>0&&(e.ships=0)})),y.value=[],Object.keys(r.systemUpdates).forEach((e=>{let t=r.systemUpdates[e];y.value.push({name:e,min:t.reduce(((e,t)=>Math.min(e,t)),1e6),avg:t.reduce(((e,t)=>e+t),0)/t.length,max:t.reduce(((e,t)=>Math.max(e,t)),0)}),r.systemUpdates[e]=[]}))}}}})})),(0,o.Jd)((()=>{g&&(g.destroy(),g=null),r&&r.destroy()})),(e,r)=>t?((0,o.wg)(),(0,o.iD)("div",I,[(0,o._)("div",T,[(0,o._)("div",k,"mainThread: "+(0,i.zw)(d.value.toFixed(2))+" ("+(0,i.zw)(l.value.toFixed(2))+" avg) ms",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,n.SU)(y),(e=>((0,o.wg)(),(0,o.iD)("div",{key:e.name},(0,i.zw)(e.name)+": "+(0,i.zw)(e.max.toFixed(2))+" ("+(0,i.zw)(e.avg.toFixed(2))+" avg) ms",1)))),128)),R,(0,o._)("div",null,"Entities: "+(0,i.zw)(p.value)+" stations and "+(0,i.zw)(m.value)+" ships",1),((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)((0,n.SU)(u),(e=>((0,o.wg)(),(0,o.iD)("span",{class:"station-list",key:e.color,style:(0,i.j5)({color:e.displayColor})},(0,i.zw)("#"+e.color.toString(16))+": "+(0,i.zw)(e.ships),5)))),128)),(0,o._)("div",null,[(0,o._)("button",{onClick:v},"Add Ships")])]),x])):((0,o.wg)(),(0,o.iD)("div",b," Browser does not suport SharedArrayBuffer "))}}),U=r(89);const _=(0,U.Z)(E,[["__scopeId","data-v-448ca91a"]]);var C=_}}]);
//# sourceMappingURL=multithreaded.b5e4df6c.js.map